// =============================================================================
// MODIFIED JAVASCRIPT FOR INDEX.HTML - FETCH DATA FROM INFINITYFREE API
// Replace the existing JavaScript in your index.html with this code
// =============================================================================

// Configuration - GANTI DENGAN URL INFINITYFREE ANDA
const API_CONFIG = {
    baseUrl: 'https://your-infinityfree-domain.com/api/products.php', // GANTI INI!
    timeout: 10000, // 10 detik timeout
    retryAttempts: 3
};

// Cache untuk performance
let productsCache = {
    data: null,
    timestamp: null,
    duration: 5 * 60 * 1000 // 5 menit
};

// DOM Elements
const header = document.getElementById('header');
const menuToggle = document.querySelector('.menu-toggle');
const navMenu = document.querySelector('.nav-menu');
const backToTop = document.getElementById('backToTop');
const loader = document.getElementById('loader');
const productModal = document.getElementById('productModal');
const closeModal = document.getElementById('closeModal');
const modalBody = document.getElementById('modalBody');
const filterButtons = document.querySelectorAll('.filter-button');
const productGrid = document.getElementById('productGrid');
const loadMoreButton = document.getElementById('loadMoreButton');
const paginationContainer = document.getElementById('paginationContainer');
const contactForm = document.getElementById('contactForm');
const cookiesBanner = document.getElementById('cookiesBanner');
const acceptCookies = document.getElementById('acceptCookies');
const cookieSettings = document.getElementById('cookieSettings');
const cookiesModal = document.getElementById('cookiesModal');
const cookiesClose = document.getElementById('cookiesClose');
const saveCookieSettings = document.getElementById('saveCookieSettings');
const acceptAllFromModal = document.getElementById('acceptAllFromModal');
const analyticsCookies = document.getElementById('analyticsCookies');
const marketingCookies = document.getElementById('marketingCookies');

// Elements untuk feature modal
const featureModal = document.getElementById('featureModal');
const featureModalIcon = document.getElementById('featureModalIcon');
const featureModalTitle = document.getElementById('featureModalTitle');
const featureModalDescription = document.getElementById('featureModalDescription');
const closeFeatureModal = document.getElementById('closeFeatureModal');
const closeFeatureModalButton = document.getElementById('closeFeatureModalButton');

// Variabel state
let currentPage = 1;
const productsPerPage = 6;
let currentFilter = 'all';
let allProducts = []; // Akan diisi dari API
let filteredProducts = [];
let isLoading = false;

// Data untuk fitur-fitur (tetap sama)
const featuresData = {
    quality: {
        icon: '<i class="fas fa-award"></i>',
        title: 'Kualitas Terjamin',
        description: 'Produk kami terbuat dari bahan berkualitas tinggi dengan standar internasional. Setiap produk melalui proses kontrol kualitas yang ketat untuk memastikan kepuasan pelanggan.'
    },
    shipping: {
        icon: '<i class="fas fa-truck"></i>',
        title: 'Gratis Pengiriman',
        description: 'Kami memberikan gratis biaya pengiriman untuk area tertentu dengan minimum pembelian. Area cakupan meliputi Pemalang dan sekitarnya dengan syarat dan ketentuan berlaku.'
    },
    price: {
        icon: '<i class="fas fa-tools"></i>',
        title: 'Harga Terjangkau',
        description: 'Kami menawarkan harga terbaik tanpa mengorbankan kualitas produk. Dapatkan produk berkualitas dengan harga kompetitif yang sesuai dengan budget Anda.'
    },
    service: {
        icon: '<i class="fas fa-medal"></i>',
        title: 'Layanan 24/7',
        description: 'Tim customer service kami siap membantu Anda kapan saja melalui WhatsApp. Konsultasi gratis untuk pemilihan produk yang tepat untuk kebutuhan Anda.'
    }
};

// =============================================================================
// API FUNCTIONS
// =============================================================================

/**
 * Fetch produk dari API dengan retry mechanism
 */
async function fetchProductsFromAPI(params = {}) {
    const url = new URL(API_CONFIG.baseUrl);
    url.searchParams.append('action', 'list');
    
    // Add parameters
    Object.keys(params).forEach(key => {
        if (params[key] !== undefined && params[key] !== null) {
            url.searchParams.append(key, params[key]);
        }
    });

    for (let attempt = 1; attempt <= API_CONFIG.retryAttempts; attempt++) {
        try {
            console.log(`Fetching products... (attempt ${attempt})`);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
            
            const response = await fetch(url.toString(), {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'API returned error');
            }
            
            console.log('Products loaded successfully:', data.data.length, 'products');
            return data;
            
        } catch (error) {
            console.error(`Attempt ${attempt} failed:`, error);
            
            if (attempt === API_CONFIG.retryAttempts) {
                throw error;
            }
            
            // Wait before retry (exponential backoff)
            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

/**
 * Load produk dengan caching
 */
async function loadProducts(forceRefresh = false) {
    if (isLoading) return;
    
    // Check cache
    const now = Date.now();
    if (!forceRefresh && 
        productsCache.data && 
        productsCache.timestamp && 
        (now - productsCache.timestamp) < productsCache.duration) {
        
        console.log('Using cached products');
        allProducts = productsCache.data;
        return allProducts;
    }
    
    isLoading = true;
    showLoader('Memuat produk...');
    
    try {
        const response = await fetchProductsFromAPI({
            limit: 50,
            category: currentFilter === 'all' ? null : currentFilter
        });
        
        allProducts = response.data || [];
        
        // Update cache
        productsCache = {
            data: allProducts,
            timestamp: now,
            duration: productsCache.duration
        };
        
        return allProducts;
        
    } catch (error) {
        console.error('Error loading products:', error);
        showError('Gagal memuat produk. Menggunakan data fallback.');
        
        // Fallback ke data dummy jika API gagal
        allProducts = getFallbackProducts();
        return allProducts;
        
    } finally {
        isLoading = false;
        hideLoader();
    }
}

/**
 * Data produk fallback jika API error
 */
function getFallbackProducts() {
    return [
        {
            id: 1,
            category: "keramik dinding",
            image: "https://images.unsplash.com/photo-1542435503-956c469947f6?fit=crop&w=600&h=400",
            name: "Keramik Dinding Abu Modern",
            price: "Rp 50.000 / mÂ²",
            description: "Keramik dinding motif abu-abu modern, cocok untuk interior minimalis.",
            features: ["Tahan air", "Permukaan glossy", "Mudah dibersihkan", "Tahan noda"],
            badge: "new"
        },
        {
            id: 2,
            category: "granit lantai",
            image: "https://images.unsplash.com/photo-1570129476811-53697e1637c3?fit=crop&w=600&h=400",
            name: "Granit Lantai Matte Hitam",
            price: "Rp 150.000 / mÂ²",
            description: "Granit lantai berwarna hitam dengan permukaan matte yang elegan.",
            features: ["Tahan gores", "Permukaan matte", "Kuat dan tahan lama", "Kesan mewah"],
            badge: "bestseller"
        }
        // Add more fallback products as needed
    ];
}

// =============================================================================
// UI FUNCTIONS
// =============================================================================

/**
 * Show loading indicator
 */
function showLoader(message = 'Memuat...') {
    if (loader) {
        loader.classList.add('active');
        const loaderText = loader.querySelector('p');
        if (loaderText) loaderText.textContent = message;
    }
}

/**
 * Hide loading indicator
 */
function hideLoader() {
    if (loader) {
        loader.classList.remove('active');
    }
}

/**
 * Show error message
 */
function showError(message) {
    // Create temporary error message
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-error';
    errorDiv.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #fee2e2;
        color: #dc2626;
        padding: 15px 20px;
        border-radius: 8px;
        border: 1px solid #fecaca;
        z-index: 2000;
        max-width: 90%;
        text-align: center;
    `;
    errorDiv.innerHTML = `âš ï¸ ${message}`;
    
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
        }
    }, 5000);
}

/**
 * Fungsi untuk render produk
 */
function renderProducts(productsToRender, page = 1) {
    const startIndex = (page - 1) * productsPerPage;
    const endIndex = startIndex + productsPerPage;
    const productsToShow = productsToRender.slice(startIndex, endIndex);
    
    if (!productGrid) return;
    
    // Clear existing products
    productGrid.innerHTML = '';
    
    if (productsToShow.length === 0) {
        productGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                <div style="font-size: 48px; color: #D1D5DB; margin-bottom: 1rem;">ðŸ“¦</div>
                <h3>Produk tidak ditemukan</h3>
                <p>Tidak ada produk yang sesuai dengan filter yang dipilih.</p>
            </div>
        `;
        return;
    }
    
    productsToShow.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.setAttribute('data-category', product.category);
        productCard.setAttribute('data-product', JSON.stringify(product));
        
        let badgeHTML = '';
        if (product.badge) {
            let badgeClass = '';
            let badgeText = '';
            
            switch(product.badge) {
                case 'new':
                    badgeClass = 'new';
                    badgeText = 'Baru';
                    break;
                case 'bestseller':
                    badgeClass = '';
                    badgeText = 'Terlaris';
                    break;
                case 'sale':
                    badgeClass = 'new';
                    badgeText = 'Hemat';
                    break;
                case 'premium':
                    badgeClass = '';
                    badgeText = 'Premium';
                    break;
            }
            
            badgeHTML = `<span class="product-badge ${badgeClass}">${badgeText}</span>`;
        }
        
        productCard.innerHTML = `
            ${badgeHTML}
            <div class="product-image-container">
                <img src="${product.image}" alt="${product.name}" class="product-image" 
                     onerror="this.src='https://images.unsplash.com/photo-1586023492125-27b2c045efd7?fit=crop&w=600&h=400';">
            </div>
            <div class="product-info">
                <h4>${product.name}</h4>
                <span class="price">${product.price}</span>
                <div class="product-actions">
                    <button class="detail-button">Detail Produk</button>
                    <button class="whatsapp-button"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                </div>
            </div>
        `;
        
        productGrid.appendChild(productCard);
    });
    
    // Update tombol load more dan pagination
    const totalPages = Math.ceil(productsToRender.length / productsPerPage);
    updateLoadMoreButton(page, totalPages);
    renderPagination(totalPages, page);
}

/**
 * Update load more button
 */
function updateLoadMoreButton(currentPage, totalPages) {
    if (!loadMoreButton) return;
    
    if (currentPage >= totalPages) {
        loadMoreButton.style.display = 'none';
    } else {
        loadMoreButton.style.display = 'block';
        loadMoreButton.disabled = false;
        loadMoreButton.textContent = 'Lihat Produk Lainnya';
    }
}

/**
 * Render pagination
 */
function renderPagination(totalPages, currentPage) {
    if (!paginationContainer) return;
    
    paginationContainer.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevButton = document.createElement('button');
    prevButton.innerHTML = '&laquo;';
    prevButton.disabled = currentPage === 1;
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) changePage(currentPage - 1);
    });
    paginationContainer.appendChild(prevButton);
    
    // Page buttons
    for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.classList.toggle('active', i === currentPage);
        pageButton.addEventListener('click', () => changePage(i));
        paginationContainer.appendChild(pageButton);
    }
    
    // Next button
    const nextButton = document.createElement('button');
    nextButton.innerHTML = '&raquo;';
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) changePage(currentPage + 1);
    });
    paginationContainer.appendChild(nextButton);
}

/**
 * Ganti halaman
 */
function changePage(page) {
    currentPage = page;
    renderProducts(filteredProducts, currentPage);
    if (productGrid) {
        window.scrollTo({
            top: productGrid.offsetTop - 100,
            behavior: 'smooth'
        });
    }
}

/**
 * Filter produk
 */
async function filterProducts(filterValue) {
    currentFilter = filterValue;
    currentPage = 1;
    
    showLoader('Memfilter produk...');
    
    try {
        // Reload products if needed
        await loadProducts();
        
        if (filterValue === 'all') {
            filteredProducts = [...allProducts];
        } else {
            filteredProducts = allProducts.filter(product => 
                product.category.toLowerCase().includes(filterValue.toLowerCase())
            );
        }
        
        renderProducts(filteredProducts, currentPage);
        
        // Update pagination visibility
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        if (paginationContainer) {
            paginationContainer.style.display = totalPages <= 1 ? 'none' : 'flex';
        }
        
    } catch (error) {
        console.error('Error filtering products:', error);
        showError('Gagal memfilter produk.');
    } finally {
        hideLoader();
    }
}

// =============================================================================
// EVENT HANDLERS
// =============================================================================

/**
 * Initialize application
 */
async function initializeApp() {
    try {
        showLoader('Memuat halaman...');
        
        // Load products
        await loadProducts();
        
        // Initial render
        await filterProducts('all');
        
        // Show cookies banner
        showCookiesBanner();
        
    } catch (error) {
        console.error('Initialization error:', error);
        showError('Gagal memuat halaman. Silakan refresh halaman.');
    } finally {
        setTimeout(() => hideLoader(), 500);
    }
}

/**
 * Handle filter button clicks
 */
filterButtons.forEach(button => {
    button.addEventListener('click', async () => {
        // Update active button
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // Filter products
        const filterValue = button.getAttribute('data-filter');
        await filterProducts(filterValue);
    });
});

/**
 * Handle load more button
 */
if (loadMoreButton) {
    loadMoreButton.addEventListener('click', () => {
        currentPage++;
        renderProducts(filteredProducts, currentPage);
    });
}

// =============================================================================
// MODAL FUNCTIONS (Sama seperti sebelumnya)
// =============================================================================

function showProductModal(productData) {
    if (!productModal || !modalBody) return;
    
    modalBody.innerHTML = `
        <div class="modal-image-container">
            <img src="${productData.image}" alt="${productData.name}" class="modal-image">
        </div>
        <div class="modal-info">
            <h3>${productData.name}</h3>
            <span class="modal-price">${productData.price}</span>
            <p class="modal-description">${productData.description}</p>
            <div class="modal-features">
                ${productData.features.map(feature => `
                    <div class="modal-feature">
                        <i class="fas fa-check"></i>
                        <span>${feature}</span>
                    </div>
                `).join('')}
            </div>
            <div class="modal-actions">
                <a href="https://wa.me/6288216124228?text=Saya%20tertarik%20dengan%20produk%20${encodeURIComponent(productData.name)}%20dari%20SEKAWAN%20JAYA" class="cta-button" target="_blank">
                    <i class="fab fa-whatsapp"></i> Pesan via WhatsApp
                </a>
                <button class="cta-button secondary" id="closeModalButton">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>
        </div>
    `;
    
    productModal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    document.getElementById('closeModalButton').addEventListener('click', closeModalFunction);
}

function showFeatureModal(featureKey) {
    const feature = featuresData[featureKey];
    
    if (feature && featureModal) {
        featureModalIcon.innerHTML = feature.icon;
        featureModalTitle.textContent = feature.title;
        featureModalDescription.textContent = feature.description;
        
        featureModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeModalFunction() {
    if (productModal) {
        productModal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

function closeFeatureModalFunction() {
    if (featureModal) {
        featureModal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// =============================================================================
// REST OF THE CODE (Sama seperti sebelumnya - Header, Navigation, etc.)
// =============================================================================

// Sticky header
window.addEventListener('scroll', () => {
    if (header) {
        if (window.scrollY > 100) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    }

    // Show/hide back to top button
    if (backToTop) {
        if (window.scrollY > 500) {
            backToTop.classList.add('active');
        } else {
            backToTop.classList.remove('active');
        }
    }
});

// Mobile menu toggle
if (menuToggle && navMenu) {
    menuToggle.addEventListener('click', () => {
        menuToggle.classList.toggle('active');
        navMenu.classList.toggle('active');
    });
}

// Close mobile menu when clicking on links
document.querySelectorAll('.nav-menu a').forEach(link => {
    link.addEventListener('click', () => {
        if (menuToggle && navMenu) {
            menuToggle.classList.remove('active');
            navMenu.classList.remove('active');
        }
    });
});

// Smooth scrolling
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
        e.preventDefault();
        
        const targetId = this.getAttribute('href');
        if (targetId === '#') return;
        
        const targetElement = document.querySelector(targetId);
        if (targetElement && header) {
            const headerHeight = header.offsetHeight;
            const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
            
            window.scrollTo({
                top: targetPosition,
                behavior: 'smooth'
            });
        }
    });
});

// Back to top
if (backToTop) {
    backToTop.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
}

// Event delegation for product interactions
document.addEventListener('click', function(e) {
    // Detail button
    if (e.target.classList.contains('detail-button') || e.target.closest('.detail-button')) {
        e.preventDefault();
        e.stopPropagation();
        
        const button = e.target.classList.contains('detail-button') ? e.target : e.target.closest('.detail-button');
        const productCard = button.closest('.product-card');
        
        if (productCard && productCard.getAttribute('data-product')) {
            try {
                const productData = JSON.parse(productCard.getAttribute('data-product'));
                showProductModal(productData);
            } catch (error) {
                console.error('Error showing product modal:', error);
                showError('Terjadi kesalahan saat memuat detail produk.');
            }
        }
    }
    
    // WhatsApp button
    if (e.target.classList.contains('whatsapp-button') || e.target.closest('.whatsapp-button')) {
        e.preventDefault();
        e.stopPropagation();
        
        const button = e.target.classList.contains('whatsapp-button') ? e.target : e.target.closest('.whatsapp-button');
        const productCard = button.closest('.product-card');
        
        if (productCard && productCard.getAttribute('data-product')) {
            try {
                const productData = JSON.parse(productCard.getAttribute('data-product'));
                const message = `Saya tertarik dengan produk ${productData.name} dari SEKAWAN JAYA`;
                const whatsappUrl = `https://wa.me/6288216124228?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            } catch (error) {
                console.error('Error opening WhatsApp:', error);
                window.open('https://wa.me/6288216124228', '_blank');
            }
        }
    }
    
    // Feature card (mobile only)
    if (e.target.closest('.feature-card') && window.innerWidth <= 768) {
        const featureCard = e.target.closest('.feature-card');
        const featureKey = featureCard.getAttribute('data-feature');
        
        if (featureKey) {
            e.preventDefault();
            showFeatureModal(featureKey);
        }
    }
});

// Modal close events
if (closeModal) closeModal.addEventListener('click', closeModalFunction);
if (closeFeatureModal) closeFeatureModal.addEventListener('click', closeFeatureModalFunction);
if (closeFeatureModalButton) closeFeatureModalButton.addEventListener('click', closeFeatureModalFunction);

// Close modals on outside click
if (productModal) {
    productModal.addEventListener('click', function(e) {
        if (e.target === productModal) closeModalFunction();
    });
}

if (featureModal) {
    featureModal.addEventListener('click', function(e) {
        if (e.target === featureModal) closeFeatureModalFunction();
    });
}

// Escape key to close modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (productModal && productModal.classList.contains('active')) closeModalFunction();
        if (featureModal && featureModal.classList.contains('active')) closeFeatureModalFunction();
    }
});

// Contact form
if (contactForm) {
    contactForm.addEventListener('submit', (e) => {
        e.preventDefault();
        showLoader('Mengirim pesan...');
        
        setTimeout(() => {
            alert('Terima kasih! Pesan Anda telah berhasil dikirim. Kami akan menghubungi Anda segera.');
            contactForm.reset();
            hideLoader();
        }, 1500);
    });
}

// =============================================================================
// COOKIES FUNCTIONALITY (Sama seperti sebelumnya)
// =============================================================================

function showCookiesBanner() {
    if (!localStorage.getItem('cookiesAccepted') && cookiesBanner) {
        setTimeout(() => {
            cookiesBanner.classList.add('active');
        }, 2000);
    }
}

function acceptAllCookies() {
    localStorage.setItem('cookiesAccepted', 'true');
    localStorage.setItem('analyticsCookies', 'true');
    localStorage.setItem('marketingCookies', 'true');
    if (cookiesBanner) cookiesBanner.classList.remove('active');
    if (cookiesModal) cookiesModal.classList.remove('active');
}

function saveCookiePreferences() {
    localStorage.setItem('cookiesAccepted', 'true');
    localStorage.setItem('analyticsCookies', analyticsCookies ? analyticsCookies.checked : 'true');
    localStorage.setItem('marketingCookies', marketingCookies ? marketingCookies.checked : 'true');
    if (cookiesModal) cookiesModal.classList.remove('active');
    if (cookiesBanner) cookiesBanner.classList.remove('active');
}

function closeCookiesBanner() {
    if (cookiesBanner) cookiesBanner.classList.remove('active');
}

// Cookies event listeners
if (acceptCookies) acceptCookies.addEventListener('click', acceptAllCookies);
if (cookieSettings) cookieSettings.addEventListener('click', () => {
    if (cookiesModal) cookiesModal.classList.add('active');
});
if (cookiesClose) cookiesClose.addEventListener('click', closeCookiesBanner);
if (saveCookieSettings) saveCookieSettings.addEventListener('click', saveCookiePreferences);
if (acceptAllFromModal) acceptAllFromModal.addEventListener('click', acceptAllCookies);

if (cookiesModal) {
    cookiesModal.addEventListener('click', (e) => {
        if (e.target === cookiesModal) cookiesModal.classList.remove('active');
    });
}

// =============================================================================
// INITIALIZE ON PAGE LOAD
// =============================================================================

document.addEventListener('DOMContentLoaded', initializeApp);

// Optional: Auto-refresh products every 10 minutes
setInterval(async () => {
    try {
        console.log('Auto-refreshing products...');
        await loadProducts(true); // Force refresh
        
        // Re-apply current filter
        if (currentFilter !== 'all') {
            await filterProducts(currentFilter);
        } else {
            filteredProducts = [...allProducts];
            renderProducts(filteredProducts, currentPage);
        }
    } catch (error) {
        console.error('Auto-refresh error:', error);
    }
}, 10 * 60 * 1000); // 10 minutes
